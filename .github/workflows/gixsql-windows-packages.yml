name: gixsql-windows-packages

on:
  workflow_dispatch

env:
  GIXSQLMAJ: 1
  GIXSQLMIN: 0
  GIXSQLREL: 20b
  GIX_REVISION: ${{ github.run_attempt }}
  GIXSQL_BRANCH: ${{ github.ref_name }}
  VCPKG_ROOT: C:\vcpkg
  GIXSQL_MSVC_X64_BIN_DIR: gixsql-windows-x64-msvc-artifacts
  GIXSQL_MSVC_X86_BIN_DIR: gixsql-windows-x86-msvc-artifacts  
  GIXSQL_MINGW_X86_BIN_DIR: gixsql-windows-x86-mingw-artifacts
  GIXSQL_MINGW_X64_BIN_DIR: gixsql-windows-x64-mingw-artifacts
  MSVC_RUNTIME_x86: https://aka.ms/vs/17/release/vc_redist.x86.exe
  MSVC_RUNTIME_x64: https://aka.ms/vs/17/release/vc_redist.x64.exe
  WORKSPACE: ${{ github.workspace }}
  DIST_DIR: ${{ github.workspace }}\DIST
  VCRTVER: 14.34.31931
  VCTOOLSVER: 143 
  MSYS2_BASE: D:/

permissions:
  contents: read

jobs:
  gixsql-windows-x64-msvc:
    name: gixsql-windows-x64-msvc
    env:
      BUILD_CONFIGURATION: Release
      HOST_PLATFORM: x64      
      BUILD_PLATFORM_ID: x64    
      SOLUTION_FILE_PATH: gixsql.sln
      
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
      with:
          repository: 'mridoni/gixsql'
          submodules: true
          ref: ${{ env.GIXSQL_BRANCH }}

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.0.2
      
    - name: Restore NuGet packages
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: nuget restore ${{env.SOLUTION_FILE_PATH}}      

    - name: Install vcpkg packages (1)
      uses: mridoni/my-vcpkg-action@v1
      with:
          pkgs: libpq libmariadb nng
          triplet: ${{env.HOST_PLATFORM}}-windows
          cache-key: '${{env.HOST_PLATFORM}}-rdynamic'
          disable-cache: false
          
    - name: Install vcpkg packages (2)
      uses: mridoni/my-vcpkg-action@v1
      with:
          pkgs: spdlog
          triplet: ${{env.HOST_PLATFORM}}-windows-static-md
          cache-key: '${{env.HOST_PLATFORM}}-rstatic'
          disable-cache: false
          
    - name: Build
      shell: cmd
      working-directory: ${{ github.workspace }}
      env:
          PATH: ${{ env.PATH}};c:\tools
      run: |
        echo VCPKG_ROOT         : ${{env.VCPKG_ROOT}}
        echo HOST_PLATFORM      : ${{env.HOST_PLATFORM}}
        echo BUILD_CONFIGURATION: ${{env.BUILD_CONFIGURATION}}
        echo SOLUTION_FILE_PATH : ${{env.SOLUTION_FILE_PATH}}
        echo JOB                : ${{ github.job }}
        echo Preparing build (${{ github.workspace }}\prepbuild.cmd)
        call ${{ github.workspace }}\prepbuild.cmd /E
        echo Initializing vcpkg
        %VCPKG_ROOT%\vcpkg integrate install
        echo Running MSBuild
        msbuild /p:Platform=${{env.BUILD_PLATFORM_ID}} /p:Configuration=${{env.BUILD_CONFIGURATION}} ${{env.SOLUTION_FILE_PATH}}  
        mkdir ${{ github.workspace }}\deps-${{env.HOST_PLATFORM}}-msvc
        copy "%VCPKG_ROOT%\installed\x64-windows\bin\libcrypto-3-x64.dll" ${{ github.workspace }}\deps-${{env.HOST_PLATFORM}}-msvc
        copy "%VCPKG_ROOT%\installed\x64-windows\bin\libmariadb.dll" ${{ github.workspace }}\deps-${{env.HOST_PLATFORM}}-msvc
        copy "%VCPKG_ROOT%\installed\x64-windows\bin\libpq.dll" ${{ github.workspace }}\deps-${{env.HOST_PLATFORM}}-msvc
        copy "%VCPKG_ROOT%\installed\x64-windows\bin\libssl-3-x64.dll" ${{ github.workspace }}\deps-${{env.HOST_PLATFORM}}-msvc
        copy "%VCPKG_ROOT%\installed\x64-windows\bin\zlib1.dll" ${{ github.workspace }}\deps-${{env.HOST_PLATFORM}}-msvc            

    - name: Archive production artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ github.job }}-artifacts
        path: |
          ${{ github.workspace }}/${{env.BUILD_PLATFORM_ID}}/${{env.BUILD_CONFIGURATION}}/*.dll
          ${{ github.workspace }}/${{env.BUILD_PLATFORM_ID}}/${{env.BUILD_CONFIGURATION}}/libgixsql.lib
          ${{ github.workspace }}/${{env.BUILD_PLATFORM_ID}}/${{env.BUILD_CONFIGURATION}}/*.exe
          
    - name: Archive dependencies
      uses: actions/upload-artifact@v3
      with:
        name: ${{ github.job }}-artifacts
        path: |
          ${{ github.workspace }}/deps-${{env.HOST_PLATFORM}}-*/             
          
  gixsql-windows-x86-msvc:
    name: gixsql-windows-x86-msvc
    env:
      BUILD_CONFIGURATION: Release
      HOST_PLATFORM: x86      
      BUILD_PLATFORM_ID: Win32    
      SOLUTION_FILE_PATH: gixsql.sln
      
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
      with:
          repository: 'mridoni/gixsql'
          submodules: true
          ref: ${{ env.GIXSQL_BRANCH }}

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.0.2
      
    - name: Restore NuGet packages
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: nuget restore ${{env.SOLUTION_FILE_PATH}}       
        
    - name: Install vcpkg packages (1)
      uses: mridoni/my-vcpkg-action@v1
      with:
          pkgs: libpq libmariadb nng
          triplet: ${{env.HOST_PLATFORM}}-windows
          cache-key: '${{env.HOST_PLATFORM}}-rdynamic'
          disable-cache: false
          
    - name: Install vcpkg packages (2)
      uses: mridoni/my-vcpkg-action@v1
      with:
          pkgs: spdlog
          triplet: ${{env.HOST_PLATFORM}}-windows-static-md
          cache-key: '${{env.HOST_PLATFORM}}-rstatic'
          disable-cache: false

    - name: Build
      shell: cmd
      working-directory: ${{ github.workspace }}
      env:
          PATH: ${{ env.PATH}};c:\tools
      run: |
        echo "VCPKG_ROOT         : ${{env.VCPKG_ROOT}}"
        echo "HOST_PLATFORM      : ${{env.HOST_PLATFORM}}"
        echo "BUILD_CONFIGURATION: ${{env.BUILD_CONFIGURATION}}"
        echo "SOLUTION_FILE_PATH : ${{env.SOLUTION_FILE_PATH}}"
        echo "JOB                : ${{ github.job }}" 
        echo Preparing build (${{ github.workspace }}\prepbuild.cmd)
        call ${{ github.workspace }}\prepbuild.cmd /E
        %VCPKG_ROOT%\vcpkg integrate install
        msbuild /p:Platform=${{env.BUILD_PLATFORM_ID}} /p:Configuration=${{env.BUILD_CONFIGURATION}} ${{env.SOLUTION_FILE_PATH}}
        mkdir ${{ github.workspace }}\deps-${{env.HOST_PLATFORM}}-msvc
        copy "%VCPKG_ROOT%\installed\x86-windows\bin\libcrypto-3.dll" ${{ github.workspace }}\deps-${{env.HOST_PLATFORM}}-msvc
        copy "%VCPKG_ROOT%\installed\x86-windows\bin\libmariadb.dll" ${{ github.workspace }}\deps-${{env.HOST_PLATFORM}}-msvc
        copy "%VCPKG_ROOT%\installed\x86-windows\bin\libpq.dll" ${{ github.workspace }}\deps-${{env.HOST_PLATFORM}}-msvc
        copy "%VCPKG_ROOT%\installed\x86-windows\bin\libssl-3.dll" ${{ github.workspace }}\deps-${{env.HOST_PLATFORM}}-msvc
        copy "%VCPKG_ROOT%\installed\x86-windows\bin\zlib1.dll" ${{ github.workspace }}\deps-${{env.HOST_PLATFORM}}-msvc
        
    - name: Archive production artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ github.job }}-artifacts
        path: |
          ${{ github.workspace }}/${{env.BUILD_PLATFORM_ID}}/${{env.BUILD_CONFIGURATION}}/*.dll
          ${{ github.workspace }}/${{env.BUILD_PLATFORM_ID}}/${{env.BUILD_CONFIGURATION}}/libgixsql.lib
          ${{ github.workspace }}/${{env.BUILD_PLATFORM_ID}}/${{env.BUILD_CONFIGURATION}}/*.exe   

    - name: Archive dependencies
      uses: actions/upload-artifact@v3
      with:
        name: ${{ github.job }}-artifacts
        path: |
          ${{ github.workspace }}/deps-${{env.HOST_PLATFORM}}-*/            
          
  gixsql-windows-x64-mingw:
    name: gixsql-windows-x64-mingw
    env:
      HOST_PLATFORM: x64
      MSYS2_SYSTEM: mingw64      
      MSYS2_PLATFORM_ID: x86_64   
      
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
      with:
          repository: 'mridoni/gixsql'    

    - name: Set up MinGW
      uses: msys2/setup-msys2@v2
      with:
        msystem: ${{env.MSYS2_SYSTEM}}
        location: ${{ env.MSYS2_BASE }}
        install: >-
            mingw-w64-${{env.MSYS2_PLATFORM_ID}}-pkg-config
            autoconf
            make
            automake
            libtool
            bison
            flex
            awk
            mingw-w64-${{env.MSYS2_PLATFORM_ID}}-gcc
            mingw-w64-${{env.MSYS2_PLATFORM_ID}}-postgresql 
            mingw-w64-${{env.MSYS2_PLATFORM_ID}}-libmariadbclient 
            mingw-w64-${{env.MSYS2_PLATFORM_ID}}-unixodbc 
            mingw-w64-${{env.MSYS2_PLATFORM_ID}}-spdlog 
            mingw-w64-${{env.MSYS2_PLATFORM_ID}}-ntldd
            
    - shell: msys2 {0}
      name: Build    
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: |
         echo lt_cv_deplibs_check_method='pass_all' >> /etc/config.site
         ls -l
         chmod 755 prepbuild.sh && ./prepbuild.sh
         chmod 755 prepdist.sh && ./prepdist.sh
         autoreconf --install --force
         ./configure --prefix=$(cygpath "${{ github.workspace }}/build-${{env.HOST_PLATFORM}}")
         make
         make install-strip  
         
    - shell: msys2 {0}
      name: Copy dependencies
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: |
         export DEPS_DIR=$(cygpath "${{ github.workspace }}/deps-${{ env.HOST_PLATFORM }}-gcc")
         export DEPS_DIR_BIN=$(cygpath "${{ github.workspace }}/deps-${{ env.HOST_PLATFORM }}-gcc-bin")
         export MSYS_BIN_DIR=$(cygpath "${{ env.MSYS2_BASE }}")msys64/${{ env.MSYS2_SYSTEM }}/bin
         export GIXSQL_BUILD_DIR=$(cygpath "${{ github.workspace }}/build-${{env.HOST_PLATFORM}}")
         mkdir $DEPS_DIR
         mkdir $DEPS_DIR_BIN
         echo "Copying $MSYS_BIN_DIR/libpq.dll to $DEPS_DIR"
         cp $MSYS_BIN_DIR/libpq.dll $DEPS_DIR
         echo "Copying $MSYS_BIN_DIR/libmariadb.dll to $DEPS_DIR"
         cp $MSYS_BIN_DIR/libmariadb.dll $DEPS_DIR
         for LIB in $(ntldd -R $MSYS_BIN_DIR/libpq.dll | grep $MSYS2_SYSTEM | awk '{printf("%s\n", $1);}') ; do echo "Copying $MSYS_BIN_DIR/$LIB to $DEPS_DIR" ; cp -f $MSYS_BIN_DIR/$LIB $DEPS_DIR ; done
         for LIB in $(ntldd -R $MSYS_BIN_DIR/libmariadb.dll | grep $MSYS2_SYSTEM | awk '{printf("%s\n", $1);}') ; do echo "Copying $MSYS_BIN_DIR/$LIB to $DEPS_DIR" ; cp -f $MSYS_BIN_DIR/$LIB $DEPS_DIR ; done            
         for LIB in $(ntldd -R $GIXSQL_BUILD_DIR/bin/gixpp.exe | grep $MSYS2_SYSTEM | awk '{printf("%s\n", $1);}') ; do echo "Copying $MSYS_BIN_DIR/$LIB to $DEPS_DIR" ; cp -f $MSYS_BIN_DIR/$LIB $DEPS_DIR_BIN ; done            
 
    - name: Archive production artifacts
      uses: actions/upload-artifact@v3
      with:
         name: ${{ github.job }}-artifacts
         path: |
           ${{ github.workspace }}/build-${{env.HOST_PLATFORM}}/bin/*.*
           ${{ github.workspace }}/build-${{env.HOST_PLATFORM}}/lib/*.*
           
    - name: Archive dependencies
      uses: actions/upload-artifact@v3
      with:
        name: ${{ github.job }}-artifacts
        path: |
           ${{ github.workspace }}/deps-${{env.HOST_PLATFORM}}-gcc/
           ${{ github.workspace }}/deps-${{env.HOST_PLATFORM}}-gcc-bin/       
           
  gixsql-windows-x86-mingw:
     name: gixsql-windows-x86-mingw
     env:
       HOST_PLATFORM: x86   
       MSYS2_SYSTEM: mingw32      
       MSYS2_PLATFORM_ID: i686   
       
     runs-on: windows-latest
     steps:
     
     - uses: actions/checkout@v3
       with:
           repository: 'mridoni/gixsql'      
 
     - name: Set up MinGW
       uses: msys2/setup-msys2@v2
       with:
         msystem: ${{env.MSYS2_SYSTEM}}
         location: ${{ env.MSYS2_BASE }}
         install: >-
             mingw-w64-${{env.MSYS2_PLATFORM_ID}}-pkg-config
             autoconf
             make
             automake
             libtool
             bison
             flex
             awk
             mingw-w64-${{env.MSYS2_PLATFORM_ID}}-gcc
             mingw-w64-${{env.MSYS2_PLATFORM_ID}}-postgresql 
             mingw-w64-${{env.MSYS2_PLATFORM_ID}}-libmariadbclient 
             mingw-w64-${{env.MSYS2_PLATFORM_ID}}-unixodbc 
             mingw-w64-${{env.MSYS2_PLATFORM_ID}}-spdlog 
             mingw-w64-${{env.MSYS2_PLATFORM_ID}}-ntldd
                     
     - shell: msys2 {0}
       name: Build
       working-directory: ${{env.GITHUB_WORKSPACE}}
       run: |
         echo lt_cv_deplibs_check_method='pass_all' >> /etc/config.site
         ls -l
         chmod 755 prepbuild.sh && ./prepbuild.sh
         chmod 755 prepdist.sh && ./prepdist.sh
         autoreconf --install --force
         ./configure --prefix=$(cygpath "${{ github.workspace }}/build-${{env.HOST_PLATFORM}}")
         make
         make install-strip  
         
     - shell: msys2 {0}
       name: Copy dependencies
       working-directory: ${{env.GITHUB_WORKSPACE}}
       run: |
         export DEPS_DIR=$(cygpath "${{ github.workspace }}/deps-${{ env.HOST_PLATFORM }}-gcc")
         export DEPS_DIR_BIN=$(cygpath "${{ github.workspace }}/deps-${{ env.HOST_PLATFORM }}-gcc-bin")
         export MSYS_BIN_DIR=$(cygpath "${{ env.MSYS2_BASE }}")msys64/${{ env.MSYS2_SYSTEM }}/bin
         export GIXSQL_BUILD_DIR=$(cygpath "${{ github.workspace }}/build-${{env.HOST_PLATFORM}}")
         mkdir $DEPS_DIR
         mkdir $DEPS_DIR_BIN
         echo "Copying $MSYS_BIN_DIR/libpq.dll to $DEPS_DIR"
         cp $MSYS_BIN_DIR/libpq.dll $DEPS_DIR
         echo "Copying $MSYS_BIN_DIR/libmariadb.dll to $DEPS_DIR"
         cp $MSYS_BIN_DIR/libmariadb.dll $DEPS_DIR
         for LIB in $(ntldd -R $MSYS_BIN_DIR/libpq.dll | grep $MSYS2_SYSTEM | awk '{printf("%s\n", $1);}') ; do echo "Copying $MSYS_BIN_DIR/$LIB to $DEPS_DIR" ; cp -f $MSYS_BIN_DIR/$LIB $DEPS_DIR ; done
         for LIB in $(ntldd -R $MSYS_BIN_DIR/libmariadb.dll | grep $MSYS2_SYSTEM | awk '{printf("%s\n", $1);}') ; do echo "Copying $MSYS_BIN_DIR/$LIB to $DEPS_DIR" ; cp -f $MSYS_BIN_DIR/$LIB $DEPS_DIR ; done            
         for LIB in $(ntldd -R $GIXSQL_BUILD_DIR/bin/gixpp.exe | grep $MSYS2_SYSTEM | awk '{printf("%s\n", $1);}') ; do echo "Copying $MSYS_BIN_DIR/$LIB to $DEPS_DIR" ; cp -f $MSYS_BIN_DIR/$LIB $DEPS_DIR_BIN ; done                
 
     - name: Archive production artifacts
       uses: actions/upload-artifact@v3
       with:
         name: ${{ github.job }}-artifacts
         path: |
           ${{ github.workspace }}/build-${{env.HOST_PLATFORM}}/bin/*.*
           ${{ github.workspace }}/build-${{env.HOST_PLATFORM}}/lib/*.*
           
     - name: Archive dependencies
       uses: actions/upload-artifact@v3
       with:
         name: ${{ github.job }}-artifacts
         path: |
           ${{ github.workspace }}/deps-${{env.HOST_PLATFORM}}-gcc/
           ${{ github.workspace }}/deps-${{env.HOST_PLATFORM}}-gcc-bin/

    
  gixsql-installer-windows-x64-msvc-mingw:
    name: gixsql-installer-windows-x64-msvc-mingw
    needs: [ gixsql-windows-x64-msvc, gixsql-windows-x86-msvc, gixsql-windows-x64-mingw, gixsql-windows-x86-mingw ]
    env:
      HOST_PLATFORM: x64      
      RUNTIME: msvc-mingw
      INCLUDE_MSVC_LIBS: 1
      
    runs-on: windows-latest
    steps:
    
    - uses: actions/checkout@v3
      with:
          repository: 'mridoni/gixsql'
          submodules: true
          ref: ${{ env.GIXSQL_BRANCH }}
          
    - name: Download GixSQL x64 (MSVC)
      uses: actions/download-artifact@v3
      with:
        name: gixsql-windows-x64-msvc-artifacts
        path: ${{ github.workspace }}/gixsql-windows-x64-msvc-artifacts

    - name: Download GixSQL x86 (MSVC)
      uses: actions/download-artifact@v3
      with:
        name: gixsql-windows-x86-msvc-artifacts
        path: ${{ github.workspace }}/gixsql-windows-x86-msvc-artifacts   

    - name: Download GixSQL x64 (MinGW)
      uses: actions/download-artifact@v3
      with:
        name: gixsql-windows-x64-mingw-artifacts
        path: ${{ github.workspace }}/gixsql-windows-x64-mingw-artifacts

    - name: Download GixSQL x86 (MinGW)
      uses: actions/download-artifact@v3
      with:
        name: gixsql-windows-x86-mingw-artifacts
        path: ${{ github.workspace }}/gixsql-windows-x86-mingw-artifacts          

    - name: Prepare distribution directory
      shell: cmd
      working-directory: ${{ github.workspace }}
      run: |
          mkdir ${{ env.DIST_DIR }}\bin
          mkdir ${{ env.DIST_DIR }}\lib
          mkdir ${{ env.DIST_DIR }}\lib\x64\msvc
          mkdir ${{ env.DIST_DIR }}\lib\x64\gcc
          mkdir ${{ env.DIST_DIR }}\lib\x86\msvc
          mkdir ${{ env.DIST_DIR }}\lib\x86\gcc        
          mkdir ${{ env.DIST_DIR }}\lib\copy    
          copy ${{ env.GIXSQL_MSVC_X64_BIN_DIR }}\gixpp.exe ${{ env.DIST_DIR }}\bin
          copy ${{ env.GIXSQL_MSVC_X64_BIN_DIR }}\libgixsql.lib ${{ env.DIST_DIR }}\lib\x64\msvc
          copy ${{ env.GIXSQL_MSVC_X64_BIN_DIR }}\libgixsql.dll ${{ env.DIST_DIR }}\lib\x64\msvc
          copy ${{ env.GIXSQL_MSVC_X64_BIN_DIR }}\libgixsql-mysql.dll ${{ env.DIST_DIR }}\lib\x64\msvc
          copy ${{ env.GIXSQL_MSVC_X64_BIN_DIR }}\libgixsql-odbc.dll ${{ env.DIST_DIR }}\lib\x64\msvc
          copy ${{ env.GIXSQL_MSVC_X64_BIN_DIR }}\libgixsql-pgsql.dll ${{ env.DIST_DIR }}\lib\x64\msvc
          copy ${{ env.GIXSQL_MSVC_X64_BIN_DIR }}\libgixsql-oracle.dll ${{ env.DIST_DIR }}\lib\x64\msvc
          copy ${{ env.GIXSQL_MSVC_X64_BIN_DIR }}\libgixsql-sqlite.dll ${{ env.DIST_DIR }}\lib\x64\msvc
          copy ${{ env.GIXSQL_MSVC_X86_BIN_DIR }}\libgixsql.lib ${{ env.DIST_DIR }}\lib\x86\msvc
          copy ${{ env.GIXSQL_MSVC_X86_BIN_DIR }}\libgixsql.dll ${{ env.DIST_DIR }}\lib\x86\msvc
          copy ${{ env.GIXSQL_MSVC_X86_BIN_DIR }}\libgixsql-mysql.dll ${{ env.DIST_DIR }}\lib\x86\msvc
          copy ${{ env.GIXSQL_MSVC_X86_BIN_DIR }}\libgixsql-odbc.dll ${{ env.DIST_DIR }}\lib\x86\msvc
          copy ${{ env.GIXSQL_MSVC_X86_BIN_DIR }}\libgixsql-pgsql.dll ${{ env.DIST_DIR }}\lib\x86\msvc
          copy ${{ env.GIXSQL_MSVC_X86_BIN_DIR }}\libgixsql-oracle.dll ${{ env.DIST_DIR }}\lib\x86\msvc
          copy ${{ env.GIXSQL_MSVC_X86_BIN_DIR }}\libgixsql-sqlite.dll ${{ env.DIST_DIR }}\lib\x86\msvc        
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\lib\libgixsql.a ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-mysql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-odbc.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-pgsql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-oracle.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-sqlite.dll ${{ env.DIST_DIR }}\lib\x86\gcc        
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\lib\libgixsql.a ${{ env.DIST_DIR }}\lib\x64\gcc
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\libgixsql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\libgixsql-mysql.dll ${{ env.DIST_DIR }}\lib\x64\gcc
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\libgixsql-odbc.dll ${{ env.DIST_DIR }}\lib\x64\gcc
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\libgixsql-pgsql.dll ${{ env.DIST_DIR }}\lib\x64\gcc
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\libgixsql-oracle.dll ${{ env.DIST_DIR }}\lib\x64\gcc
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\libgixsql-sqlite.dll ${{ env.DIST_DIR }}\lib\x64\gcc      
          
    - name: Add GixSQL dependencies
      shell: cmd
      working-directory: ${{ github.workspace }}
      run: |
          mkdir ${{ github.workspace }}\redist\deps\x64\msvc
          mkdir ${{ github.workspace }}\redist\deps\x64\gcc
          copy ${{ env.GIXSQL_MSVC_X64_BIN_DIR }}\deps-x64-msvc\*.* ${{ env.DIST_DIR }}\lib\x64\msvc          
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\deps-x64-gcc\*.* ${{ env.DIST_DIR }}\lib\x64\gcc   
          mkdir ${{ github.workspace }}\redist\deps\x86\msvc
          mkdir ${{ github.workspace }}\redist\deps\x86\gcc
          copy ${{ env.GIXSQL_MSVC_X86_BIN_DIR }}\deps-x86-msvc\*.* ${{ env.DIST_DIR }}\lib\x86\msvc          
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\deps-x86-gcc\*.* ${{ env.DIST_DIR }}\lib\x86\gcc          
          
    - name: Add VC++ runtime
      shell: cmd
      working-directory: ${{ github.workspace }}
      run: |
          FOR /F "tokens=*" %%g IN ('vswhere -property installationPath') do (SET VSPATH=%%g)
          mkdir ${{ github.workspace }}\redist\msvcrt\x64
          copy "%VSPATH%\VC\Redist\MSVC\${{ env.VCRTVER }}\x64\Microsoft.VC${{ env.VCTOOLSVER }}.CRT\vcruntime140.dll" ${{ github.workspace }}\redist\msvcrt\x64
          copy "%VSPATH%\VC\Redist\MSVC\${{ env.VCRTVER }}\x64\Microsoft.VC${{ env.VCTOOLSVER }}.CRT\vcruntime140_1.dll" ${{ github.workspace }}\redist\msvcrt\x64
          copy "%VSPATH%\VC\Redist\MSVC\${{ env.VCRTVER }}\x64\Microsoft.VC${{ env.VCTOOLSVER }}.CRT\msvcp140.dll" ${{ github.workspace }}\redist\msvcrt\x64
          copy "%VSPATH%\VC\Redist\MSVC\${{ env.VCRTVER }}\x64\Microsoft.VC${{ env.VCTOOLSVER }}.CRT\msvcp140_1.dll" ${{ github.workspace }}\redist\msvcrt\x64
          copy "%VSPATH%\VC\Redist\MSVC\${{ env.VCRTVER }}\x64\Microsoft.VC${{ env.VCTOOLSVER }}.CRT\msvcp140_2.dll" ${{ github.workspace }}\redist\msvcrt\x64    
          mkdir ${{ github.workspace }}\redist\msvcrt\x86
          copy "%VSPATH%\VC\Redist\MSVC\${{ env.VCRTVER }}\x86\Microsoft.VC${{ env.VCTOOLSVER }}.CRT\vcruntime140.dll" ${{ github.workspace }}\redist\msvcrt\x86
          copy "%VSPATH%\VC\Redist\MSVC\${{ env.VCRTVER }}\x86\Microsoft.VC${{ env.VCTOOLSVER }}.CRT\vcruntime140_1.dll" ${{ github.workspace }}\redist\msvcrt\x86
          copy "%VSPATH%\VC\Redist\MSVC\${{ env.VCRTVER }}\x86\Microsoft.VC${{ env.VCTOOLSVER }}.CRT\msvcp140.dll" ${{ github.workspace }}\redist\msvcrt\x86
          copy "%VSPATH%\VC\Redist\MSVC\${{ env.VCRTVER }}\x86\Microsoft.VC${{ env.VCTOOLSVER }}.CRT\msvcp140_1.dll" ${{ github.workspace }}\redist\msvcrt\x86
          copy "%VSPATH%\VC\Redist\MSVC\${{ env.VCRTVER }}\x86\Microsoft.VC${{ env.VCTOOLSVER }}.CRT\msvcp140_2.dll" ${{ github.workspace }}\redist\msvcrt\x86                  
          
    - name: Build installer package
      shell: cmd
      env:
        WORKSPACE: ${{ github.workspace }}
        GIX_VER: ${{ env.GIXSQLMAJ }}.${{ env.GIXSQLMIN }}.${{ env.GIXSQLREL }}-${{ env.GIX_REVISION }}
      run: |
        iscc.exe ${{ github.workspace }}\deploy\installers\windows\gixsql.iss
        ren ${{ github.workspace }}\deploy\installers\gixsql-${{ env.HOST_PLATFORM }}\gixsql-${{ env.GIX_VER }}-installer.exe ${{ github.job }}-${{ env.GIX_VER }}.exe
        
    - name: Archive production artifacts
      uses: actions/upload-artifact@v3
      env:
            GIX_VER: ${{ env.GIXSQLMAJ }}.${{ env.GIXSQLMIN }}.${{ env.GIXSQLREL }}-${{ env.GIX_REVISION }}
      with:
        name: ${{ github.job }}-${{ env.GIX_VER }}
        path: ${{ github.workspace }}\deploy\installers\gixsql-${{ env.HOST_PLATFORM }}\${{ github.job }}-${{ env.GIX_VER }}.exe

  gixsql-installer-windows-x86-msvc-mingw:
    name: gixsql-installer-windows-x86-msvc-mingw
    needs: [ gixsql-windows-x86-msvc,  gixsql-windows-x86-mingw ]
    env:
      HOST_PLATFORM: x86      
      RUNTIME: msvc-mingw
      INCLUDE_MSVC_LIBS: 1

    runs-on: windows-latest
    steps:
    
    - uses: actions/checkout@v3
      with:
          repository: 'mridoni/gixsql'
          submodules: true
          ref: ${{ env.GIXSQL_BRANCH }}
          
    - name: Download gixsql x86
      uses: actions/download-artifact@v3
      with:
        name: gixsql-windows-x86-msvc-artifacts
        path: ${{ github.workspace }}/gixsql-windows-x86-msvc-artifacts   

    - name: Download GixSQL x86 (MinGW)
      uses: actions/download-artifact@v3
      with:
        name: gixsql-windows-x86-mingw-artifacts
        path: ${{ github.workspace }}/gixsql-windows-x86-mingw-artifacts     

    - name: Prepare distribution directory
      shell: cmd
      working-directory: ${{ github.workspace }}
      run: |
          mkdir ${{ env.DIST_DIR }}\bin
          mkdir ${{ env.DIST_DIR }}\lib
          mkdir ${{ env.DIST_DIR }}\lib\x86\msvc
          mkdir ${{ env.DIST_DIR }}\lib\x86\gcc        
          mkdir ${{ env.DIST_DIR }}\lib\copy    
          copy ${{ env.GIXSQL_MSVC_X86_BIN_DIR }}\gixpp.exe ${{ env.DIST_DIR }}\bin
          copy ${{ env.GIXSQL_MSVC_X86_BIN_DIR }}\libgixsql.lib ${{ env.DIST_DIR }}\lib\x86\msvc
          copy ${{ env.GIXSQL_MSVC_X86_BIN_DIR }}\libgixsql.dll ${{ env.DIST_DIR }}\lib\x86\msvc
          copy ${{ env.GIXSQL_MSVC_X86_BIN_DIR }}\libgixsql-mysql.dll ${{ env.DIST_DIR }}\lib\x86\msvc
          copy ${{ env.GIXSQL_MSVC_X86_BIN_DIR }}\libgixsql-odbc.dll ${{ env.DIST_DIR }}\lib\x86\msvc
          copy ${{ env.GIXSQL_MSVC_X86_BIN_DIR }}\libgixsql-pgsql.dll ${{ env.DIST_DIR }}\lib\x86\msvc
          copy ${{ env.GIXSQL_MSVC_X86_BIN_DIR }}\libgixsql-oracle.dll ${{ env.DIST_DIR }}\lib\x86\msvc
          copy ${{ env.GIXSQL_MSVC_X86_BIN_DIR }}\libgixsql-sqlite.dll ${{ env.DIST_DIR }}\lib\x86\msvc     
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\lib\libgixsql.a ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-mysql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-odbc.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-pgsql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-oracle.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-sqlite.dll ${{ env.DIST_DIR }}\lib\x86\gcc          

    - name: Add GixSQL dependencies
      shell: cmd
      working-directory: ${{ github.workspace }}
      run: |
          mkdir ${{ github.workspace }}\redist\deps\x86\msvc
          mkdir ${{ github.workspace }}\redist\deps\x86\gcc
          copy ${{ env.GIXSQL_MSVC_X86_BIN_DIR }}\deps-x86-msvc\*.* ${{ env.DIST_DIR }}\lib\x86\msvc          
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\deps-x86-gcc\*.* ${{ env.DIST_DIR }}\lib\x86\gcc             
          
    - name: Add VC++ runtime
      shell: cmd
      working-directory: ${{ github.workspace }}
      run: |
          FOR /F "tokens=*" %%g IN ('vswhere -property installationPath') do (SET VSPATH=%%g)
          mkdir ${{ github.workspace }}\redist\msvcrt\x86
          copy "%VSPATH%\VC\Redist\MSVC\${{ env.VCRTVER }}\x86\Microsoft.VC${{ env.VCTOOLSVER }}.CRT\vcruntime140.dll" ${{ github.workspace }}\redist\msvcrt\x86
          copy "%VSPATH%\VC\Redist\MSVC\${{ env.VCRTVER }}\x86\Microsoft.VC${{ env.VCTOOLSVER }}.CRT\vcruntime140_1.dll" ${{ github.workspace }}\redist\msvcrt\x86
          copy "%VSPATH%\VC\Redist\MSVC\${{ env.VCRTVER }}\x86\Microsoft.VC${{ env.VCTOOLSVER }}.CRT\msvcp140.dll" ${{ github.workspace }}\redist\msvcrt\x86
          copy "%VSPATH%\VC\Redist\MSVC\${{ env.VCRTVER }}\x86\Microsoft.VC${{ env.VCTOOLSVER }}.CRT\msvcp140_1.dll" ${{ github.workspace }}\redist\msvcrt\x86
          copy "%VSPATH%\VC\Redist\MSVC\${{ env.VCRTVER }}\x86\Microsoft.VC${{ env.VCTOOLSVER }}.CRT\msvcp140_2.dll" ${{ github.workspace }}\redist\msvcrt\x86        
          
    - name: Build installer package
      shell: cmd
      env:
        WORKSPACE: ${{ github.workspace }}
        GIX_VER: ${{ env.GIXSQLMAJ }}.${{ env.GIXSQLMIN }}.${{ env.GIXSQLREL }}-${{ env.GIX_REVISION }}
      run: |
        iscc.exe ${{ github.workspace }}\deploy\installers\windows\gixsql.iss
        ren ${{ github.workspace }}\deploy\installers\gixsql-${{ env.HOST_PLATFORM }}\gixsql-${{ env.GIX_VER }}-installer.exe ${{ github.job }}-${{ env.GIX_VER }}.exe
        
    - name: Archive production artifacts
      uses: actions/upload-artifact@v3
      env:
            GIX_VER: ${{ env.GIXSQLMAJ }}.${{ env.GIXSQLMIN }}.${{ env.GIXSQLREL }}-${{ env.GIX_REVISION }}
      with:
        name: ${{ github.job }}-${{ env.GIX_VER }}
        path: ${{ github.workspace }}\deploy\installers\gixsql-${{ env.HOST_PLATFORM }}\${{ github.job }}-${{ env.GIX_VER }}.exe

  gixsql-installer-windows-x64-mingw:
    name: gixsql-installer-windows-x64-mingw
    needs: [ gixsql-windows-x64-mingw, gixsql-windows-x86-mingw ]
    env:
      HOST_PLATFORM: x64   
      RUNTIME: mingw
      INCLUDE_MSVC_LIBS: 0

    runs-on: windows-latest
    steps:
    
    - uses: actions/checkout@v3
      with:
          repository: 'mridoni/gixsql'
          submodules: true
          ref: ${{ env.GIXSQL_BRANCH }}

    - name: Download GixSQL x64 (MinGW)
      uses: actions/download-artifact@v3
      with:
        name: gixsql-windows-x64-mingw-artifacts
        path: ${{ github.workspace }}/gixsql-windows-x64-mingw-artifacts

    - name: Download GixSQL x86 (MinGW)
      uses: actions/download-artifact@v3
      with:
        name: gixsql-windows-x86-mingw-artifacts
        path: ${{ github.workspace }}/gixsql-windows-x86-mingw-artifacts          

    - name: Prepare distribution directory
      shell: cmd
      working-directory: ${{ github.workspace }}
      run: |
          mkdir ${{ env.DIST_DIR }}\bin
          mkdir ${{ env.DIST_DIR }}\lib
          mkdir ${{ env.DIST_DIR }}\lib\x64\gcc
          mkdir ${{ env.DIST_DIR }}\lib\x86\gcc        
          mkdir ${{ env.DIST_DIR }}\lib\copy    
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\gixpp.exe ${{ env.DIST_DIR }}\bin      
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\lib\libgixsql.a ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-mysql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-odbc.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-pgsql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-oracle.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-sqlite.dll ${{ env.DIST_DIR }}\lib\x86\gcc        
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\lib\libgixsql.a ${{ env.DIST_DIR }}\lib\x64\gcc
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\libgixsql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\libgixsql-mysql.dll ${{ env.DIST_DIR }}\lib\x64\gcc
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\libgixsql-odbc.dll ${{ env.DIST_DIR }}\lib\x64\gcc
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\libgixsql-pgsql.dll ${{ env.DIST_DIR }}\lib\x64\gcc
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\libgixsql-oracle.dll ${{ env.DIST_DIR }}\lib\x64\gcc
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\libgixsql-sqlite.dll ${{ env.DIST_DIR }}\lib\x64\gcc      
          
    - name: Add GixSQL dependencies
      shell: cmd
      working-directory: ${{ github.workspace }}
      run: |
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\deps-x64-gcc-bin\*.* ${{ env.DIST_DIR }}\bin   
          mkdir ${{ env.DIST_DIR }}\lib\x64\gcc  
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\deps-x64-gcc\*.* ${{ env.DIST_DIR }}\lib\x64\gcc   
          mkdir ${{ env.DIST_DIR }}\lib\x86\gcc         
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\deps-x86-gcc\*.* ${{ env.DIST_DIR }}\lib\x86\gcc                 
          
    - name: Build installer package
      shell: cmd
      env:
        WORKSPACE: ${{ github.workspace }}
        GIX_VER: ${{ env.GIXSQLMAJ }}.${{ env.GIXSQLMIN }}.${{ env.GIXSQLREL }}-${{ env.GIX_REVISION }}
      run: |
        iscc.exe ${{ github.workspace }}\deploy\installers\windows\gixsql.iss
        ren ${{ github.workspace }}\deploy\installers\gixsql-${{ env.HOST_PLATFORM }}\gixsql-${{ env.GIX_VER }}-installer.exe ${{ github.job }}-${{ env.GIX_VER }}.exe
        
    - name: Archive production artifacts
      uses: actions/upload-artifact@v3
      env:
            GIX_VER: ${{ env.GIXSQLMAJ }}.${{ env.GIXSQLMIN }}.${{ env.GIXSQLREL }}-${{ env.GIX_REVISION }}
      with:
        name: ${{ github.job }}-${{ env.GIX_VER }}
        path: ${{ github.workspace }}\deploy\installers\gixsql-${{ env.HOST_PLATFORM }}\${{ github.job }}-${{ env.GIX_VER }}.exe

    
  gixsql-installer-windows-x86-mingw:
    name: gixsql-installer-windows-x86-mingw
    needs: [ gixsql-windows-x86-mingw ]
    env:
      HOST_PLATFORM: x86
      RUNTIME: mingw
      INCLUDE_MSVC_LIBS: 0

    runs-on: windows-latest
    steps:
    
    - uses: actions/checkout@v3
      with:
          repository: 'mridoni/gixsql'
          submodules: true
          ref: ${{ env.GIXSQL_BRANCH }}

    - name: Download GixSQL x86 (MinGW)
      uses: actions/download-artifact@v3
      with:
        name: gixsql-windows-x86-mingw-artifacts
        path: ${{ github.workspace }}/gixsql-windows-x86-mingw-artifacts      
        
    - name: Prepare distribution directory
      shell: cmd
      working-directory: ${{ github.workspace }}
      run: |
          mkdir ${{ env.DIST_DIR }}\bin
          mkdir ${{ env.DIST_DIR }}\lib
          mkdir ${{ env.DIST_DIR }}\lib\x86\msvc
          mkdir ${{ env.DIST_DIR }}\lib\x86\gcc        
          mkdir ${{ env.DIST_DIR }}\lib\copy    
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\gixpp.exe ${{ env.DIST_DIR }}\bin  
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\lib\libgixsql.a ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-mysql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-odbc.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-pgsql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-oracle.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-sqlite.dll ${{ env.DIST_DIR }}\lib\x86\gcc       

    - name: Add GixSQL dependencies
      shell: cmd
      working-directory: ${{ github.workspace }}
      run: |
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\deps-x86-gcc-bin\*.* ${{ env.DIST_DIR }}\bin   
          mkdir ${{ env.DIST_DIR }}\lib\x86\gcc      
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\deps-x86-gcc\*.* ${{ env.DIST_DIR }}\lib\x86\gcc               

    - name: Build installer package
      shell: cmd
      env:
        WORKSPACE: ${{ github.workspace }}
        GIX_VER: ${{ env.GIXSQLMAJ }}.${{ env.GIXSQLMIN }}.${{ env.GIXSQLREL }}-${{ env.GIX_REVISION }}
      run: |
        iscc.exe ${{ github.workspace }}\deploy\installers\windows\gixsql.iss
        ren ${{ github.workspace }}\deploy\installers\gixsql-${{ env.HOST_PLATFORM }}\gixsql-${{ env.GIX_VER }}-installer.exe ${{ github.job }}-${{ env.GIX_VER }}.exe
        
    - name: Archive production artifacts
      uses: actions/upload-artifact@v3
      env:
            GIX_VER: ${{ env.GIXSQLMAJ }}.${{ env.GIXSQLMIN }}.${{ env.GIXSQLREL }}-${{ env.GIX_REVISION }}
      with:
        name: ${{ github.job }}-${{ env.GIX_VER }}
        path: ${{ github.workspace }}\deploy\installers\gixsql-${{ env.HOST_PLATFORM }}\${{ github.job }}-${{ env.GIX_VER }}.exe

  gixsql-binaries-windows-x64-mingw:
    name: gixsql-binaries-windows-x64-mingw
    needs: [ gixsql-windows-x64-mingw, gixsql-windows-x86-mingw ]
    env:
      HOST_PLATFORM: x64   
      RUNTIME: mingw

    runs-on: windows-latest
    steps:
    
    - uses: actions/checkout@v3
      with:
          repository: 'mridoni/gixsql'
          submodules: true
          ref: ${{ env.GIXSQL_BRANCH }}

    - name: Download GixSQL x64 (MinGW)
      uses: actions/download-artifact@v3
      with:
        name: gixsql-windows-x64-mingw-artifacts
        path: ${{ github.workspace }}/gixsql-windows-x64-mingw-artifacts

    - name: Download GixSQL x86 (MinGW)
      uses: actions/download-artifact@v3
      with:
        name: gixsql-windows-x86-mingw-artifacts
        path: ${{ github.workspace }}/gixsql-windows-x86-mingw-artifacts          

    - name: Prepare distribution directory
      shell: cmd
      working-directory: ${{ github.workspace }}
      run: |
          mkdir ${{ env.DIST_DIR }}\bin
          mkdir ${{ env.DIST_DIR }}\lib
          mkdir ${{ env.DIST_DIR }}\lib\x64\gcc
          mkdir ${{ env.DIST_DIR }}\lib\x86\gcc        
          mkdir ${{ env.DIST_DIR }}\lib\copy    
          mkdir ${{ env.DIST_DIR }}\doc
          mkdir ${{ env.DIST_DIR }}\examples
          copy LICENSE ${{ env.DIST_DIR }}\doc
          copy README.md ${{ env.DIST_DIR }}\doc
          copy TESTING.md ${{ env.DIST_DIR }}\doc
          copy gixsql-tests-nunit\data\*.cbl ${{ env.DIST_DIR }}\examples
          copy gixsql-tests-nunit\data\*.cpy ${{ env.DIST_DIR }}\examples
          copy gixsql-tests-nunit\data\*.sql ${{ env.DIST_DIR }}\examples
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\gixpp.exe ${{ env.DIST_DIR }}\bin      
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\lib\libgixsql.a ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-mysql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-odbc.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-pgsql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-oracle.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-sqlite.dll ${{ env.DIST_DIR }}\lib\x86\gcc        
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\lib\libgixsql.a ${{ env.DIST_DIR }}\lib\x64\gcc
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\libgixsql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\libgixsql-mysql.dll ${{ env.DIST_DIR }}\lib\x64\gcc
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\libgixsql-odbc.dll ${{ env.DIST_DIR }}\lib\x64\gcc
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\libgixsql-pgsql.dll ${{ env.DIST_DIR }}\lib\x64\gcc
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\libgixsql-oracle.dll ${{ env.DIST_DIR }}\lib\x64\gcc
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\bin\libgixsql-sqlite.dll ${{ env.DIST_DIR }}\lib\x64\gcc    
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\deps-x64-gcc\*.* ${{ env.DIST_DIR }}\lib\x64\gcc
          
    - name: Add GixSQL dependencies
      shell: cmd
      working-directory: ${{ github.workspace }}
      run: |
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\deps-x64-gcc-bin\*.* ${{ env.DIST_DIR }}\bin   
          mkdir ${{ env.DIST_DIR }}\lib\x64\gcc  
          copy ${{ env.GIXSQL_MINGW_X64_BIN_DIR }}\deps-x64-gcc\*.* ${{ env.DIST_DIR }}\lib\x64\gcc   
          mkdir ${{ env.DIST_DIR }}\lib\x86\gcc         
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\deps-x86-gcc\*.* ${{ env.DIST_DIR }}\lib\x86\gcc                 

    - name: Build archive package
      shell: cmd
      env:
        WORKSPACE: ${{ github.workspace }}
        GIX_VER: ${{ env.GIXSQLMAJ }}.${{ env.GIXSQLMIN }}.${{ env.GIXSQLREL }}-${{ env.GIX_REVISION }}
      run: |
        ren ${{ env.DIST_DIR }} ${{ github.job }}
        7z a -r ${{ github.job }}.7z ${{ github.job }}
        ren ${{ github.job }}.7z ${{ github.job }}-${{ env.GIX_VER }}.7z
        
    - name: Archive production artifacts
      uses: actions/upload-artifact@v3
      env:
            GIX_VER: ${{ env.GIXSQLMAJ }}.${{ env.GIXSQLMIN }}.${{ env.GIXSQLREL }}-${{ env.GIX_REVISION }}
      with:
        name: ${{ github.job }}-${{ env.GIX_VER }}
        path: ${{ github.job }}-${{ env.GIX_VER }}.7z

  gixsql-binaries-windows-x86-mingw:
    name: gixsql-binaries-windows-x86-mingw
    needs: [ gixsql-windows-x86-mingw ]
    env:
      HOST_PLATFORM: x86
      RUNTIME: mingw

    runs-on: windows-latest
    steps:
    
    - uses: actions/checkout@v3
      with:
          repository: 'mridoni/gixsql'
          submodules: true
          ref: ${{ env.GIXSQL_BRANCH }}

    - name: Download GixSQL x86 (MinGW)
      uses: actions/download-artifact@v3
      with:
        name: gixsql-windows-x86-mingw-artifacts
        path: ${{ github.workspace }}/gixsql-windows-x86-mingw-artifacts      
        
    - name: Prepare distribution directory
      shell: cmd
      working-directory: ${{ github.workspace }}
      run: |
          mkdir ${{ env.DIST_DIR }}\bin
          mkdir ${{ env.DIST_DIR }}\lib
          mkdir ${{ env.DIST_DIR }}\lib\x86\gcc        
          mkdir ${{ env.DIST_DIR }}\lib\copy    
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\gixpp.exe ${{ env.DIST_DIR }}\bin  
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\lib\libgixsql.a ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-mysql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-odbc.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-pgsql.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-oracle.dll ${{ env.DIST_DIR }}\lib\x86\gcc
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\bin\libgixsql-sqlite.dll ${{ env.DIST_DIR }}\lib\x86\gcc     
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\deps-x86-gcc\*.* ${{ env.DIST_DIR }}\lib\x86\gcc
          
    - name: Add GixSQL dependencies
      shell: cmd
      working-directory: ${{ github.workspace }}
      run: |
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\deps-x86-gcc-bin\*.* ${{ env.DIST_DIR }}\bin   
          mkdir ${{ env.DIST_DIR }}\lib\x86\gcc         
          copy ${{ env.GIXSQL_MINGW_X86_BIN_DIR }}\deps-x86-gcc\*.* ${{ env.DIST_DIR }}\lib\x86\gcc                   
          
    - name: Build archive package
      shell: cmd
      env:
        WORKSPACE: ${{ github.workspace }}
        GIX_VER: ${{ env.GIXSQLMAJ }}.${{ env.GIXSQLMIN }}.${{ env.GIXSQLREL }}-${{ env.GIX_REVISION }}
      run: |
        ren ${{ env.DIST_DIR }} ${{ github.job }}
        7z a -r ${{ github.job }}.7z ${{ github.job }}
        ren ${{ github.job }}.7z ${{ github.job }}-${{ env.GIX_VER }}.7z
        
    - name: Archive production artifacts
      uses: actions/upload-artifact@v3
      env:
            GIX_VER: ${{ env.GIXSQLMAJ }}.${{ env.GIXSQLMIN }}.${{ env.GIXSQLREL }}-${{ env.GIX_REVISION }}
      with:
        name: ${{ github.job }}-${{ env.GIX_VER }}
        path: ${{ github.job }}-${{ env.GIX_VER }}.7z
        
  build-cleanup:
    name: build-cleanup
    needs: [ gixsql-installer-windows-x64-msvc-mingw, gixsql-installer-windows-x86-msvc-mingw, gixsql-installer-windows-x64-mingw, gixsql-installer-windows-x86-mingw, gixsql-binaries-windows-x64-mingw, gixsql-binaries-windows-x86-mingw ]
    runs-on: windows-latest
    steps:
    
    - uses: geekyeggo/delete-artifact@v2
      with:
          name: |
            gixsql-windows-x64-msvc-artifacts 
            gixsql-windows-x86-msvc-artifacts 
            gixsql-windows-x86-mingw-artifacts 
            gixsql-windows-x64-mingw-artifacts  
            
